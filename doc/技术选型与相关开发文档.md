### 3.1 技术选型与相关开发文档

1. 项目背景

随着移动互联网的普及和消费者购物习惯的变化，社交电商呈现出蓬勃发展的趋势。抖音作为一款拥有庞大用户群体的短视频社交平台，具有巨大的电商潜力。通过搭建电商平台，抖音可以为用户提供更加丰富的购物体验，同时为商家提供新的销售渠道，实现用户、商家和平台的多赢局面。

2. 项目目标

一句话做一个“简易版”抖音商城。为用户提供便捷、优质的购物环境，满足用户多样化的购物需求，打造一个具有影响力的社交电商平台，提升抖音在电商领域的市场竞争力。

3. 解决问题：

#### 技术需求：

（一）注册中心集成

1. 服务注册与发现
   1. 该服务能够与注册中心（如 Consul、Nacos 、etcd 等）进行集成，自动注册服务数据。

（二）身份认证

1. 登录认证
   1. 可以使用第三方现成的登录验证框架（CasBin、Satoken等），对请求进行身份验证
   2. 可配置的认证白名单，对于某些不需要认证的接口或路径，允许直接访问
   3. 可配置的黑名单，对于某些异常的用户，直接进行封禁处理（可选）
2. 权限认证（高级）
   1. 根据用户的角色和权限，对请求进行授权检查，确保只有具有相应权限的用户能够访问特定的服务或接口。
   2. 支持正则表达模式的权限匹配（加分项）
   3. 支持动态更新用户权限信息，当用户权限发生变化时，权限校验能够实时生效。

（三）可观测要求

1. 日志记录与监控
   1. 对服务的运行状态和请求处理过程进行详细的日志记录，方便故障排查和性能分析。
   2. 提供实时监控功能，能够及时发现和解决系统中的问题。

（四）可靠性要求（高级）

1. 容错机制
   1. 该服务应具备一定的容错能力，当出现部分下游服务不可用或网络故障时，能够自动切换到备用服务或进行降级处理。
   2. 保证下游在异常情况下，系统的整体可用性不会受太大影响，且核心服务可用。
   3. 服务应该具有一定的流量兜底措施，在服务流量激增时，应该给予一定的限流措施。

#### 功能需求： 

**认证中心** ，**用户服务**， **商品服务** ，**购物车服务**，**订单服务**，**结算** ，**支付**

#### 技术选型

我们采用go语言去完成这个项目，其中，我们采用技术框架为：

* http：[Hertz](https://github.com/cloudwego/hertz) 

* rpc远程调用：[Kitex](https://github.com/cloudwego/kitex) 
* CURD：Gorm
* Redis：GoRedis

然后我们采用docker进行打包然后部署。

我们采用微服务的方式去调用各项功能，微服务的优点有：

1. **高可用性**：
   微服务架构将应用拆分成多个服务单元，每个服务可以独立部署和扩展。如果某个服务发生故障，只会影响该服务，其他服务仍然可以继续工作，从而提高系统的可靠性和可用性。
2. **可扩展性**：
   微服务允许单独的服务进行水平扩展（横向扩展），每个服务可以根据负载需要单独增加实例或机器。这种灵活的扩展能力是传统单体架构难以实现的。
3. **灵活的技术选型**：
   每个微服务可以使用适合的技术栈进行开发，可以采用不同的数据库、编程语言或框架。例如，你们选用了Go语言、Hertz、Kitex、Gorm和GoRedis，这些技术可以在微服务中独立运作并能与其他服务交互。
4. **独立部署与快速迭代**：
   每个微服务可以独立开发和部署，因此不需要等待整个系统完成。服务间通过 API 或 RPC 调用协作，可以实现高效的持续集成和快速部署，支持快速迭代。
5. **分布式数据管理**：
   微服务架构支持每个服务拥有自己的数据库，避免了传统单体应用中的单一数据库瓶颈。你们使用Gorm和GoRedis来管理数据库和缓存，使得数据的存取可以独立管理。
6. **易于维护与更新**：
   微服务结构化了系统，将各个模块拆分为独立服务，便于后续的维护和更新。每次修改都局限于服务的一个部分，其他服务不受影响，降低了维护成本。

#### 1. **存储空间估算**

根据选型，假设每个微服务的数据存储需要独立部署。使用Gorm和GoRedis分别进行数据库持久化和缓存管理。

- 每个服务会有自己的数据库（例如MySQL或PostgreSQL）和缓存（例如Redis）。
- 假设每个数据库需要10GB存储，每个缓存服务需要5GB存储。
- 假设有10个微服务，那么数据库和缓存的总存储需求为：
  - **数据库存储：** 10个服务 × 10GB = **100GB**
  - **缓存存储：** 10个服务 × 5GB = **50GB**

预计系统总存储需求为 **150GB**（用于数据库和缓存）。

#### 2. **服务器数量估算**

微服务架构要求每个服务独立部署。假设每台服务器的性能可以运行4个微服务实例。

- 假设有10个微服务，那么至少需要3台服务器来容纳这些微服务实例（4个服务/台 × 3台服务器 > 10个服务）。
- 考虑到负载均衡和高可用性，预计至少需要 **5台服务器**（1台用于数据库，1台用于缓存，3台用于应用服务）。

所以，预计需要 **5台服务器**，每台服务器运行多个微服务实例。

#### 3. **负载均衡和故障恢复**

微服务架构需要设置负载均衡器来分发请求，确保服务的高可用性。如果某个服务实例故障，负载均衡器会自动将请求转发给其他健康实例。

- 预估需要在服务器层面部署 **负载均衡器**（如Nginx或HAProxy）来管理流量。
- 在容器化环境下，使用 **Kubernetes** 来自动化管理微服务的部署、扩展和故障恢复。

#### 4. **网络与通信**

微服务之间的通信通常通过API或RPC进行。你们选用的技术栈中使用了 **Kitex** 进行RPC远程调用，**Hertz** 处理HTTP请求。

- 假设微服务间的通信量较大，预计需要合理配置 **带宽** 和 **延迟优化**。选择合适的负载均衡、容器网络配置，以及采用 **服务发现机制** 来优化服务之间的调用。

#### 5. **监控与日志**

微服务架构中，每个服务都需要独立监控和日志管理。

- 使用 **Prometheus**  进行服务监控。
- 使用 **ELK Stack**（Elasticsearch, Logstash, Kibana）进行日志收集和分析。
- 假设每个服务会产生一定的日志数据和监控数据，预计需要单独配置监控服务器或日志服务器。

#### 6. **安全性**

微服务架构需要对每个服务进行身份验证和授权。建议采用 **JWT** 进行微服务间的安全通信。

- 确保服务间的数据加密传输，避免敏感信息泄漏。

### 总结的预期需求

- **存储需求**：预计总存储需求为 **150GB**（包括数据库和缓存）。
- **服务器数量**：预计需要 **5台服务器**，其中至少3台用于微服务部署，1台用于数据库，1台用于缓存。
- **网络要求**：需要高带宽、低延迟的网络配置，支持高效的微服务通信。
- **监控与日志**：部署监控工具和日志管理系统来确保服务的健康。
- **安全性**：确保服务间的安全通信和数据保护。

#### 相关开发文档：



### 3.2 架构设计

#### 1. 场景分析与要解决的问题

在设计系统架构时，需充分考虑不同用户行为的需求，尤其是用户在高峰期的购买需求。以下是几个重要的用户场景及其问题：

- **高并发购买场景**：
  当平台推出大规模促销、秒杀活动时，用户可能在短时间内同时购买大量商品。此时，系统需要在短时间内处理**大量订单请求**，并且需要对订单状态、支付状态进行实时更新。系统必须保障高并发订单的处理能力、数据一致性以及交易的成功率。

  例如，在“双十一”促销期间，单日交易量可能达到百万级别，每秒钟可能会有成千上万的订单请求提交到服务器，系统必须能够承载这些请求并确保每个订单的准确处理。

#### 2. 前提假设

为了有效应对这些需求，我们提出以下前提假设，确保架构设计能够满足用户的高并发购买场景：

- **用户规模与交易量预测**：
  - 预计平台日活跃用户数为 **1000万**，其中 5% 的用户（即 **50万**）将参与到大规模促销和秒杀活动中。
  - 在促销活动中，假设每位用户将购买平均 **3件商品**，单个商品价格在几十元至几百元不等。
  - 每秒钟可能会有数千个并发订单请求，预计 **高峰期订单量** 达到 **每秒5000单**，并且订单提交会在短时间内集中的时间段发生。
- **系统性能需求**：
  - 为了处理高并发购买需求，系统需具备 **水平扩展能力**，在订单高峰期间能够动态增加服务器资源。
  - 对于订单数据，需要保障系统具备 **高并发数据写入** 和 **事务一致性**，确保在高峰期间不会出现订单丢失或重复提交的情况。
  - 每个订单的支付状态和库存状态都需要在 **分布式系统中保持一致性**，并通过 **异步处理** 或 **消息队列** 确保高效处理。
- **数据存储与缓存需求**：
  - 由于订单系统对数据一致性要求高，采用分布式数据库（如 MySQL + Redis）存储用户信息、订单数据和商品库存等关键数据。
  - 高并发购买时，为了避免数据库的瓶颈，采用 **Redis缓存** 商品库存、支付状态等热点数据，减少数据库查询压力。
  - 为了提升系统性能，需要合理设计 **数据库分库分表** 策略，将用户、订单等数据按照规则进行拆分，以提高读写性能和系统的扩展能力。

#### 3. 当前架构的解决方案

针对上述问题和前提假设，当前架构设计解决方案如下：

- **负载均衡与高可用性**：
  在高并发购买场景下，使用 **负载均衡器**（Kubernetes 的负载均衡机制）将用户的请求分配到多个服务器实例，确保系统能够处理大规模并发请求。并通过 **自动扩展** 功能，在系统负载增加时自动增减服务器实例，以应对突发流量。
- **分布式事务处理与数据一致性**：
  由于订单和支付的高并发，采用 **分布式事务管理**（**TCC模式**）确保多个服务间的数据一致性。例如，在用户下单、支付、库存扣减等多个环节间，通过消息队列或事件驱动系统来保证各个环节的顺利完成，避免数据不一致。
- **高效的库存管理**：
  对于秒杀商品和大规模促销商品，平台需要提前对商品库存进行预热，确保在高并发的情况下库存能够实时更新。使用 **Redis缓存** 商品的库存信息，当用户提交订单时，先通过缓存验证库存，再进行支付和库存扣减。
- **异步订单处理与排队机制**：
  由于高并发下的订单提交可能导致订单处理的时延，平台采用 **消息队列**（Kafka）进行异步处理，将订单提交、支付校验、库存扣减等任务进行异步排队，确保系统不会因为瞬时并发量过大而崩溃。
- **数据库与缓存的结合使用**：
  使用 **MySQL + Redis** 的组合来处理订单和库存管理。对于非热点数据，存储在 MySQL 数据库中；对于热点数据（如库存、支付状态等），则通过 Redis 缓存进行优化，减少数据库查询压力。

通过这些技术方案，平台能够有效应对用户高并发购买行为，确保系统的稳定性和高效性。